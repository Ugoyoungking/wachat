
/**
 * Core Philosophy: This ruleset establishes a security model centered on user ownership and controlled interaction.
 * A user has full control over their own data (profile, devices, custom AIs), which is structurally segregated into a
 * user-specific path. User profiles are readable by any authenticated user to enable discovery and chat initiation.
 * Chat messages are stored in a top-level collection and are only accessible by the sender and recipient, ensuring
 * conversation privacy.
 *
 * Data Structure:
 * - /users/{userId}: Publicly readable user profiles, writable only by the owner.
 * - /users/{userId}/devices/{deviceId}: Private device information, accessible only by the owner.
 * - /users/{userId}/customAIs/{customAIId}: Private AI configurations, accessible only by the owner.
 * - /chats/{chatId}: Private chat metadata, accessible only to participants.
 * - /chats/{chatId}/messages/{messageId}: Private chat messages, accessible only to participants of the chat.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Returns true if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the requesting user's UID matches the provided userId.
     * Used for path-based ownership checks.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * Returns true if the requesting user is a participant in the chat.
     */
    function isChatParticipant() {
      return isSignedIn() && request.auth.uid in resource.data.userIds;
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (get, list) - Any authenticated user can read user profiles to discover other users.
     * @allow (create, update, delete) - A user can only write to their own profile document.
     */
    match /users/{userId} {
      allow get, list: if isSignedIn();
      allow create: if isOwner(userId);
      // Allow updates for status and lastSeen by the user themselves
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }
    
    /**
     * @description Secures chat metadata.
     * @path /chats/{chatId}
     * @allow (get) - Only participants of the chat can read chat metadata.
     * @allow (list) - Users can only query for chats they are a part of, ordered by timestamp.
     * @allow (create) - Any signed-in user can create a chat.
     * @allow (update, delete) - Only participants of the chat can modify or delete it.
     */
    match /chats/{chatId} {
      allow get: if isChatParticipant();
      allow list: if isSignedIn() 
                  && request.query.where.size() == 1
                  && request.query.where[0].field == "userIds"
                  && request.query.where[0].op == "array-contains"
                  && request.query.where[0].value == request.auth.uid
                  && request.query.orderBy.size() == 1
                  && request.query.orderBy[0].field == "lastMessage.timestamp"
                  && request.query.orderBy[0].direction == "desc";
      allow create: if isSignedIn();
      allow update, delete: if isChatParticipant();
    }
    
    /**
     * @description Secures messages within a chat.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (all) - Only participants of the parent chat can access messages.
     * @allow update - Allow participants to update the 'read' status.
     */
    match /chats/{chatId}/messages/{messageId} {
      allow read, write: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.userIds;
    }

    /**
     * @description Secures the private device information for a user.
     * @path /users/{userId}/devices/{deviceId}
     * @allow (all) - A user can manage their own list of linked devices.
     */
    match /users/{userId}/devices/{deviceId} {
      allow read, write, delete: if isOwner(userId);
    }

    /**
     * @description Secures the private Custom AI configurations for a user.
     * @path /users/{userId}/customAIs/{customAIId}
     * @allow (all) - A user can create, read, update, and delete their own custom AIs.
     */
    match /users/{userId}/customAIs/{customAIId} {
       allow read, write, delete: if isOwner(userId);
    }
  }
}
