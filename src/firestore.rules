
/**
 * Core Philosophy: This ruleset establishes a security model centered on user ownership and controlled interaction.
 * A user has full control over their own data (profile, devices, custom AIs), which is structurally segregated into a
 * user-specific path. User profiles are readable by any authenticated user to enable discovery and chat initiation.
 * Chat messages are stored in a top-level collection and are only accessible by the sender and recipient, ensuring
 * conversation privacy.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Returns true if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the requesting user's UID matches the provided userId.
     * Used for path-based ownership checks.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * Returns true if the requesting user is a participant in the chat.
     */
    function isChatParticipant(chatId) {
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.userIds;
    }

    /**
     * Returns true if the requesting user is the caller or callee of the call.
     */
     function isCallParticipant(callId) {
        let call = get(/databases/$(database)/documents/calls/$(callId)).data;
        return isSignedIn() && (request.auth.uid == call.callerId || request.auth.uid == call.calleeId);
     }


    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get, list: if isSignedIn();
      // A user can create their own profile.
      allow create: if isOwner(userId);
      // A user can update their own profile, but only specific fields.
      // This prevents a user from maliciously changing their ID or email.
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }
    
    /**
     * @description Secures chat metadata.
     * @path /chats/{chatId}
     */
    match /chats/{chatId} {
      // A user can read a chat document if they are a participant.
      allow get: if isChatParticipant(chatId);
      
      // A user can query for their own chats, but only if they filter by their user ID.
      allow list: if isSignedIn() && request.query.filters.size() == 1 && 'userIds' in request.query.filters && request.query.filters.userIds[0] == 'array-contains' && request.query.filters.userIds[1] == request.auth.uid;

      // A user can create a chat if they are signed in and their UID is in the userIds array of the new document.
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.userIds;
      
      // A user can update a chat (e.g., lastMessage, typing status) if they are a participant.
      allow update: if isChatParticipant(chatId);
    }
    
    /**
     * @description Secures messages within a chat.
     * @path /chats/{chatId}/messages/{messageId}
     */
    match /chats/{chatId}/messages/{messageId} {
      // Users can read/write messages if they are part of the chat.
      // Additionally, allow updates for read receipts.
      allow read, write: if isChatParticipant(chatId);
    }

    /**
     * @description Secures the private device information for a user.
     * @path /users/{userId}/devices/{deviceId}
     */
    match /users/{userId}/devices/{deviceId} {
      allow read, write, delete: if isOwner(userId);
    }

    /**
     * @description Secures the private Custom AI configurations for a user.
     * @path /users/{userId}/customAIs/{customAIId}
     */
    match /users/{userId}/customAIs/{customAIId} {
       allow read, write, delete: if isOwner(userId);
    }

    /**
     * @description Secures the WebRTC signaling documents.
     * @path /calls/{callId}
     */
     match /calls/{callId} {
       // Only the caller or callee can access the call document.
       allow get, write, delete: if isCallParticipant(callId);
       allow create: if isSignedIn() && request.auth.uid == request.resource.data.callerId;
       // Allow a user to query for calls where they are the callee to listen for incoming calls.
       allow list: if isSignedIn() && request.query.where.calleeId == request.auth.uid;
     }
  }
}
