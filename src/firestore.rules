
/**
 * Core Philosophy: This ruleset establishes a security model centered on user ownership and controlled interaction.
 * A user has full control over their own data (profile, devices, custom AIs), which is structurally segregated into a
 * user-specific path. User profiles are readable by any authenticated user to enable discovery and chat initiation.
 * Chat messages are stored in a top-level collection and are only accessible by the sender and recipient, ensuring
 * conversation privacy.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Returns true if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the requesting user's UID matches the provided userId.
     * Used for path-based ownership checks.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * Returns true if the requesting user is a participant in the chat.
     */
    function isChatParticipant(chatId) {
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.userIds;
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get, list: if isSignedIn();
      // A user can create their own profile.
      allow create: if isOwner(userId);
      // A user can update their own profile, but only specific fields.
      // This prevents a user from maliciously changing their ID or email.
      allow update: if isOwner(userId) &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['name', 'avatar', 'status', 'lastSeen']);
      allow delete: if isOwner(userId);
    }
    
    /**
     * @description Secures chat metadata.
     * @path /chats/{chatId}
     */
    match /chats/{chatId} {
      // A user can read a chat document if they are a participant.
      allow get: if isChatParticipant(chatId);
      
      // A user can list chats ONLY if they are querying for their own chats.
      // This rule enforces that the 'userIds' field must be used in a where clause.
      allow list: if isSignedIn() && request.query.where.userIds == request.auth.uid;

      // A user can create a chat if they are signed in and their UID is in the userIds array of the new document.
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.userIds;
      
      // A user can update a chat (e.g., lastMessage, typing status) if they are a participant.
      allow update: if isChatParticipant(chatId);
    }
    
    /**
     * @description Secures messages within a chat.
     * @path /chats/{chatId}/messages/{messageId}
     */
    match /chats/{chatId}/messages/{messageId} {
      allow read, write, delete: if isChatParticipant(chatId);
      
      // Allow participants to update the 'read' status or reactions on a message.
      // This is more specific than a general 'write' and is good practice.
      allow update: if isChatParticipant(chatId) &&
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'reactions']));
    }

    /**
     * @description Secures the private device information for a user.
     * @path /users/{userId}/devices/{deviceId}
     */
    match /users/{userId}/devices/{deviceId} {
      allow read, write, delete: if isOwner(userId);
    }

    /**
     * @description Secures the private Custom AI configurations for a user.
     * @path /users/{userId}/customAIs/{customAIId}
     */
    match /users/{userId}/customAIs/{customAIId} {
       allow read, write, delete: if isOwner(userId);
    }
  }
}
